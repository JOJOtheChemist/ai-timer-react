# AI对话页（AIChatPage）业务域-文件映射表

| AI对话页核心功能                       | 对应业务域        | 后端文件路径                              | 核心函数/接口说明                                                                                                                                                                                                                                                 |
| -------------------------------------- | ----------------- | ----------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1. AI对话交互（发送消息、AI回复）      | ai                | api/v1/endpoints/ai/ai_chat.py            | - POST /api/v1/ai/chat：发送用户消息，获取AI流式/同步回复`<br>`- GET /api/v1/ai/chat/history：获取当前用户的聊天历史记录（支持分页）                                                                                                                            |
|                                        | ai                | services/ai/ai_chat_service.py            | - send_chat_message(user_id, user_message)：处理用户消息（校验内容、调用大模型），返回AI回复`<br>`- get_chat_history(user_id, page, page_size)：查询用户聊天历史，按时间戳倒序排列                                                                              |
|                                        | ai                | crud/ai/crud_ai_chat.py                   | - create_chat_record(db, user_id, message_data)：保存聊天记录（用户/AI消息均存储）`<br>`- get_multi_by_user(db, user_id, page, page_size)：按用户ID查询聊天历史                                                                                                 |
|                                        | ai                | models/schemas/ai.py                      | - ChatMessageCreate：用户消息请求模型（含content字段）`<br>`- ChatResponse：AI回复响应模型（支持流式/完整文本，含is_analysis标记）`<br>`- ChatHistoryResponse：聊天历史响应模型（含消息列表、分页信息）                                                       |
| 2. 时间表AI分析（问题识别、优化建议）  | ai                | api/v1/endpoints/ai/ai_analysis.py        | - GET /api/v1/ai/analysis/schedule：基于用户最近时间表生成分析（含问题标签、优化建议）                                                                                                                                                                            |
|                                        | ai                | services/ai/ai_analysis_service.py        | - analyze_schedule(user_id)：获取用户最近时间表数据（调用schedule业务域接口），传给大模型生成分析结果（问题标签、效率优化点）`<br>`- 自动过滤无效数据（如未完成的时段任务）                                                                                     |
|                                        | ai                | crud/ai/crud_ai_analysis.py               | - create_analysis_record(db, user_id, analysis_data)：保存时间表分析结果（便于后续复用，减少重复调用大模型）`<br>`- get_latest_analysis(db, user_id)：查询用户最近一次的时间表分析结果（有效期1天）                                                             |
|                                        | ai                | models/schemas/ai.py                      | - ScheduleAnalysisResponse：时间表分析响应模型（含tags、analysis、recommendations列表）                                                                                                                                                                           |
| 3. AI推荐跳转（方法/案例/导师）        | ai                | api/v1/endpoints/ai/ai_recommendations.py | - 复用AI分析接口（GET /api/v1/ai/analysis/schedule），返回推荐数据（含类型、名称、路径、描述）                                                                                                                                                                    |
|                                        | ai                | services/ai/ai_recommendation_service.py  | - generate_recommendations(user_id, analysis_data)：基于时间表分析结果，匹配推荐资源（调用method/case/tutor业务域接口获取基础信息）`<br>`- 按“相关性”排序推荐（如“复习不足”优先推荐艾宾浩斯法）                                                             |
|                                        | method/case/tutor | 复用对应业务域的crud层                    | - 推荐学习方法：调用 `crud/method/crud_method.py`的 `get_by_name`获取方法基础信息`<br>`- 推荐案例：调用 `crud/case/crud_case.py`的 `get_similar_by_tag`获取相似案例`<br>`- 推荐导师：调用 `crud/tutor/crud_tutor.py`的 `get_by_field`获取匹配导师 |
|                                        | ai                | models/schemas/ai.py                      | - RecommendationItem：推荐项模型（含type、icon、name、desc、path字段，区分method/case/tutor）                                                                                                                                                                     |
| 4. 工具按钮功能（复盘总结/生成计划等） | ai                | api/v1/endpoints/ai/ai_tools.py           | - GET /api/v1/ai/tools/summary：生成用户学习复盘总结（基于时间表+聊天记录）`<br>`- POST /api/v1/ai/tools/plan：生成个性化学习计划（支持同步到时间表）                                                                                                           |
|                                        | ai                | services/ai/ai_tool_service.py            | - generate_study_summary(user_id)：整合用户时间表数据（调用schedule）和聊天记录，生成复盘总结（时长分布、完成率、改进点）`<br>`- generate_study_plan(user_id, plan_params)：生成学习计划，支持调用 `schedule-service`同步到用户时间表                         |
|                                        | ai                | crud/ai/crud_ai_tool.py                   | - create_summary_record(db, user_id, summary_data)：保存复盘总结（有效期7天）`<br>`- create_plan_record(db, user_id, plan_data)：保存生成的学习计划（关联时间表ID）                                                                                             |
|                                        | ai                | models/schemas/ai.py                      | - StudySummaryResponse：复盘总结响应模型（含时长统计、完成率、改进建议）`<br>`- StudyPlanCreate：学习计划生成参数模型（含目标、周期等）                                                                                                                         |
| 5. 推荐资源跳转（方法/案例/导师页）    | method/case/tutor | 复用对应业务域的api层                     | - 学习方法跳转：复用 `method-service`的 `GET /api/v1/methods/{method_id}`接口`<br>`- 案例跳转：复用 `case-service`的 `GET /api/v1/cases/{case_id}`接口`<br>`- 导师跳转：复用 `tutor-service`的 `GET /api/v1/tutors/{tutor_id}`接口                |
|                                        | ai                | services/ai/ai_recommendation_service.py  | - get_recommendation_detail(recommend_type, recommend_id)：根据推荐类型和ID，调用对应业务域接口获取资源详情（用于跳转前的弹窗描述）                                                                                                                               |
| 6. 聊天历史记录查看                    | ai                | api/v1/endpoints/ai/ai_chat.py            | - 复用GET /api/v1/ai/chat/history接口，支持按时间范围筛选（如“近7天”）                                                                                                                                                                                          |
|                                        | ai                | services/ai/ai_chat_service.py            | - get_chat_history_by_time(user_id, start_time, end_time)：按时间范围查询聊天记录（扩展基础历史查询功能）                                                                                                                                                         |

### 说明

1. **核心业务域聚焦**：AI对话、分析、工具功能均归为 `ai`业务域，核心逻辑（大模型调用、分析推荐）内聚，避免与其他业务域耦合；推荐跳转仅负责“提供资源关联信息”，不存储具体资源数据（如学习方法、案例），需调用对应业务域接口。
2. **跨域数据调用**：`ai`业务域需获取用户时间表（`schedule`）、学习方法（`method`）、案例（`case`）等数据时，通过**调用对应业务域的API**实现（如 `ai_analysis_service`调用 `schedule-service`的 `GET /api/v1/schedule/user`接口），不直接操作其他业务域的数据库，确保数据一致性。
3. **流式响应支持**：AI回复接口（`POST /api/v1/ai/chat`）默认支持流式返回（适配前端实时展示AI打字效果），通过 `stream=true`参数控制，后端需在 `ai_chat_service`中封装大模型的流式调用逻辑（如豆包API的stream模式）。
4. **缓存优化**：时间表分析结果（`ai_analysis_service`）默认缓存1天，避免重复调用大模型；聊天历史分页查询（`ai_chat_service`）支持缓存热门记录（如最近10条），提升前端加载速度。

如果需要继续分析剩余页面，直接提供对应的React文件即可～
