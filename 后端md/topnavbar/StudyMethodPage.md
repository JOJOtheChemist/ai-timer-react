# 学习方法页（StudyMethodPage）业务域-文件映射表

| 学习方法页核心功能                          | 对应业务域               | 后端文件路径                                                                                                                              | 核心函数/接口说明                                                                                                                                                                                                       |
| ------------------------------------------- | ------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1. AI推荐学习方法（基于时间表分析）         | ai                       | api/v1/endpoints/ai/ai_recommendations.py                                                                                                 | - GET /api/v1/ai/recommendations/method：获取针对用户的学习方法推荐（基于时间表数据，如“复习频率低”推荐艾宾浩斯法）                                                                                                   |
|                                             | ai                       | services/ai/ai_recommend_service.py                                                                                                       | - recommend_study_method(user_id)：分析用户时间表数据（调用schedule业务域接口），匹配适配的学习方法（调用method业务域接口获取方法基础信息）`<br>`- 按“相关性+打卡人数”排序推荐结果                                  |
|                                             | method                   | crud/method/crud_method.py                                                                                                                | - get_suitable_by_user_behavior(db, user_behavior_tags, limit=1)：根据用户行为标签（如“复习不足”）查询适配的学习方法                                                                                                  |
|                                             | models/schemas/ai.py     | - AIStudyMethodResponse：AI推荐学习方法响应模型（含method基础信息、推荐理由desc）                                                         |                                                                                                                                                                                                                         |
| 2. 学习方法列表展示（筛选分类）             | method                   | api/v1/endpoints/method/methods.py                                                                                                        | - GET /api/v1/methods：获取学习方法列表（支持筛选参数：category，如“通用方法/导师独创”）`<br>`- 自动返回方法的打卡人数、评分（关联统计数据）                                                                        |
|                                             | method                   | services/method/method_service.py                                                                                                         | - get_method_list(filters, page, page_size)：按筛选条件查询方法列表，调用statistic_service补充打卡人数和评分`<br>`- 缓存热门方法列表（调用cache_service.set，有效期1小时）                                            |
|                                             | method                   | crud/method/crud_method.py                                                                                                                | - get_multi_by_category(db, category, page, page_size)：按分类查询学习方法基础数据                                                                                                                                      |
|                                             | statistic                | services/statistic/statistic_service.py                                                                                                   | - count_method_checkins(db, method_id)：统计单个方法的总打卡人数`<br>`- calculate_method_rating(db, method_id)：计算单个方法的评分（基于用户评价）                                                                    |
|                                             | models/schemas/method.py | - MethodListResponse：学习方法列表响应模型（含name、category、meta、stats等）`<br>`- MethodFilterParams：筛选参数模型（仅category字段） |                                                                                                                                                                                                                         |
| 3. 学习方法详情展示（步骤、场景）           | method                   | api/v1/endpoints/method/methods.py                                                                                                        | - GET /api/v1/methods/{method_id}：获取单个学习方法的完整详情（含description、steps、scene、meta等）                                                                                                                    |
|                                             | method                   | services/method/method_service.py                                                                                                         | - get_method_detail(method_id)：查询方法完整信息，校验方法状态（如是否已下架）`<br>`- 复用statistic_service获取实时打卡人数和评分                                                                                     |
|                                             | method                   | crud/method/crud_method.py                                                                                                                | - get_by_id(db, method_id)：查询方法完整基础数据（含steps、scene等）                                                                                                                                                    |
|                                             | models/schemas/method.py | - MethodDetailResponse：学习方法详情响应模型（含description、steps、scene、stats等）                                                      |                                                                                                                                                                                                                         |
| 4. 学习方法打卡（类型选择、进度提交、心得） | method                   | api/v1/endpoints/method/checkins.py                                                                                                       | - POST /api/v1/methods/{method_id}/checkin：提交学习方法打卡（请求体含checkin_type、progress、note）`<br>`- GET /api/v1/methods/{method_id}/checkins/history：查询当前用户的该方法打卡历史                            |
|                                             | method                   | services/method/checkin_service.py                                                                                                        | - create_checkin(user_id, method_id, checkin_data)：处理打卡逻辑（校验method_id合法性、进度范围；保存打卡记录；同步更新方法总打卡数）`<br>`- get_user_checkin_history(user_id, method_id)：查询用户对该方法的打卡历史 |
|                                             | method                   | crud/method/crud_checkin.py                                                                                                               | - create(db, user_id, method_id, checkin_data)：保存打卡记录到CheckinRecord表`<br>`- get_multi_by_user_method(db, user_id, method_id)：查询用户-方法的打卡历史                                                        |
|                                             | method                   | models/schemas/method.py                                                                                                                  | - CheckinCreate：打卡请求模型（checkin_type、progress、note）`<br>`- CheckinResponse：打卡响应模型（含checkin_time、progress、note等）                                                                                |
| 5. 打卡统计展示（人数、评分）               | method                   | api/v1/endpoints/method/methods.py                                                                                                        | - 复用GET /api/v1/methods和GET /api/v1/methods/{method_id}接口，返回stats字段（打卡人数、评分）                                                                                                                         |
|                                             | statistic                | services/statistic/statistic_service.py                                                                                                   | - count_method_checkins(db, method_id)：统计方法总打卡人数（查询CheckinRecord表去重用户数）`<br>`- calculate_method_rating(db, method_id)：计算方法评分（基于打卡记录中的rating字段，取平均值）                       |
|                                             | method                   | crud/method/crud_method.py                                                                                                                | - update_checkin_count(db, method_id)：更新StudyMethod表的checkin_count字段（打卡人数变更时同步）                                                                                                                       |

### 说明

1. **业务域核心聚焦**：学习方法的“展示、筛选、打卡”均归 `method`业务域，因为这些功能强依赖“学习方法实体”（Method）及其关联数据（打卡记录CheckinRecord）；AI推荐归 `ai`业务域，复用之前的用户行为分析逻辑，避免与方法核心逻辑耦合。
2. **跨域调用逻辑**：
   - AI推荐学习方法时，`ai_service`需调用 `method_service`的 `get_suitable_by_user_behavior`接口，获取适配的方法数据；
   - 打卡后同步“方法总打卡数”时，`checkin_service`调用 `statistic_service`的统计函数，再通过 `crud_method`更新方法的 `checkin_count`字段，确保统计数据实时准确。
3. **缓存优化**：热门学习方法列表（如“通用方法”分类下的高打卡方法）通过 `cache_service.set`缓存，`method_service`在查询列表时优先读缓存，缓存失效后再查数据库并更新缓存，减少数据库压力，提升前端加载速度。
4. **打卡数据安全**：打卡接口通过 `user`业务域的 `get_current_user`依赖校验用户身份，确保“用户只能为自己打卡”，且 `crud_checkin`通过 `user_id+method_id+checkin_date`（隐含日期）避免单日重复打卡（需在service层添加重复校验逻辑）。

如果需要继续分析最后一个页面，直接提供对应的React文件即可～
