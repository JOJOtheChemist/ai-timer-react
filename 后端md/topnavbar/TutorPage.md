# 导师页（TutorPage）业务域-文件映射表

| 导师页核心功能                       | 对应业务域             | 后端文件路径                                                                                                                                            | 核心函数/接口说明                                                                                                                                                                                                                      |
| ------------------------------------ | ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1. 导师列表展示（筛选/排序/搜索）    | tutor                  | api/v1/endpoints/tutor/tutors.py                                                                                                                        | - GET /api/v1/tutors：获取导师列表（支持筛选参数：tutor_type、domain、price_range等；支持排序参数：sort_by）`<br>`- GET /api/v1/tutors/search：按关键词搜索导师（匹配姓名、擅长领域）                                                |
|                                      | tutor                  | services/tutor/tutor_service.py                                                                                                                         | - get_tutor_list(filters, sort_by, page, page_size)：按筛选条件+排序规则查询导师列表，计算分页信息`<br>`- search_tutors(keyword, page, page_size)：按关键词模糊匹配导师（姓名/领域）                                                 |
|                                      | tutor                  | crud/tutor/crud_tutor.py                                                                                                                                | - get_multi_by_filters(db, filters, sort_by, page, page_size)：按筛选条件+排序执行数据库查询`<br>`- search_by_keyword(db, keyword, page, page_size)：关键词搜索导师（关联领域标签）                                                  |
|                                      | tutor                  | models/schemas/tutor.py                                                                                                                                 | - TutorListResponse：导师列表响应模型（含基础信息、metrics、服务摘要）`<br>`- TutorFilterParams：筛选参数模型（tutor_type、domain、price_range等）                                                                                   |
| 2. 导师详情查看（profile/服务/评价） | tutor                  | api/v1/endpoints/tutor/tutor_details.py                                                                                                                 | - GET /api/v1/tutors/{tutor_id}：获取单个导师的完整详情（含profile、服务详情、指导数据、学员评价）                                                                                                                                     |
|                                      | tutor                  | services/tutor/tutor_detail_service.py                                                                                                                  | - get_tutor_detail(tutor_id)：查询导师完整信息，关联查询服务列表、评价列表、指导数据`<br>`- 校验导师状态（如是否已认证、服务是否可用）                                                                                               |
|                                      | tutor                  | crud/tutor/crud_tutor.py                                                                                                                                | - get_by_id_with_relations(db, tutor_id)：查询导师基础信息，关联查询服务表（tutor_services）、评价表（tutor_reviews）、指导数据表（tutor_metrics）                                                                                     |
|                                      | tutor                  | crud/tutor/crud_tutor_review.py                                                                                                                         | - get_multi_by_tutor(db, tutor_id, page=1, page_size=10)：查询指定导师的学员评价（默认取前10条）                                                                                                                                       |
|                                      | tutor                  | models/schemas/tutor.py                                                                                                                                 | - TutorDetailResponse：导师详情响应模型（含profile、service_details、data_panel、reviews等）`<br>`- TutorReviewResponse：学员评价响应模型（含reviewer、rating、content等）                                                           |
| 3. 导师服务购买（扣钻石、生成订单）  | user                   | api/v1/endpoints/user/user_assets.py                                                                                                                    | - POST /api/v1/users/me/assets/purchase：提交导师服务购买请求（含tutor_id、service_id）`<br>`- GET /api/v1/users/me/orders/tutor：查询用户的导师服务订单历史                                                                         |
|                                      | user                   | services/user/user_asset_service.py                                                                                                                     | - purchase_tutor_service(user_id, tutor_id, service_id)：处理服务购买逻辑（校验钻石余额、扣减钻石、生成订单）`<br>`- 若余额不足，返回错误提示；成功则生成订单并同步导师服务购买记录                                                  |
|                                      | user                   | crud/user/crud_user_asset.py                                                                                                                            | - deduct_diamond(db, user_id, amount)：扣减用户钻石（需加事务，确保原子性）`<br>`- get_asset_balance(db, user_id)：查询用户当前钻石余额                                                                                              |
|                                      | tutor                  | crud/tutor/crud_tutor_service_order.py                                                                                                                  | - create_order(db, user_id, tutor_id, service_id, amount)：创建导师服务订单（记录订单状态、金额、时间）                                                                                                                                |
|                                      | models/schemas/user.py | - TutorServicePurchaseCreate：服务购买请求模型（tutor_id、service_id）`<br>`- TutorServiceOrderResponse：订单响应模型（含order_id、status、amount等） |                                                                                                                                                                                                                                        |
| 4. 私信导师（发送私信）              | user                   | api/v1/endpoints/user/user_relations.py                                                                                                                 | - POST /api/v1/users/me/relations/message/tutor/{tutor_id}：向指定导师发送私信`<br>`- 复用“消息中心”的私信存储逻辑                                                                                                                 |
|                                      | user                   | services/user/user_relation_service.py                                                                                                                  | - send_tutor_message(user_id, tutor_id, content)：校验导师状态（是否存在），创建私信记录（接收方为导师）`<br>`- 触发私信提醒（如导师的消息中心未读计数+1）                                                                           |
|                                      | user                   | crud/user/crud_user_message.py                                                                                                                          | - create_private_message(db, sender_id, receiver_id, content, message_type='tutor')：创建私信记录（标记消息类型为“导师私信”）                                                                                                        |
|                                      | models/schemas/user.py | - PrivateMessageCreate：私信发送请求模型（receiver_id、content）`<br>`- PrivateMessageResponse：私信响应模型（含sender、receiver、content、time等）   |                                                                                                                                                                                                                                        |
| 5. 关注导师（建立用户-导师关注关系） | user                   | api/v1/endpoints/user/user_relations.py                                                                                                                 | - POST /api/v1/users/me/relations/follow/tutor/{tutor_id}：关注指定导师`<br>`- DELETE /api/v1/users/me/relations/follow/tutor/{tutor_id}：取消关注导师`<br>`- GET /api/v1/users/me/relations/follow/tutors：查询用户关注的导师列表 |
|                                      | user                   | services/user/user_relation_service.py                                                                                                                  | - toggle_tutor_follow(user_id, tutor_id)：切换关注状态（已关注则取消，未关注则新增）`<br>`- 校验导师合法性，避免重复关注                                                                                                             |
|                                      | user                   | crud/user/crud_user_relation.py                                                                                                                         | - create_tutor_follow(db, user_id, tutor_id)：创建用户-导师关注关系（唯一约束：user_id+tutor_id）`<br>`- delete_tutor_follow(db, user_id, tutor_id)：删除关注关系`<br>`- get_followed_tutors(db, user_id)：查询用户关注的导师列表  |
|                                      | models/schemas/user.py | - FollowResponse：关注操作响应模型（含is_followed状态、follow_time等）                                                                                  |                                                                                                                                                                                                                                        |

### 说明

1. **业务域划分逻辑**：

   - 导师基础信息、服务、评价等核心数据归 `teacher`业务域，确保“导师相关功能内聚”；
   - 私信、关注属于“用户与导师的关系互动”，归 `user`业务域（与之前“用户关系链”功能统一）；
   - 服务购买涉及“钻石扣减+订单生成”，归 `user`业务域的“资产模块”（复用现有钻石管理逻辑，避免重复开发支付功能）。
2. **跨域调用处理**：

   - 购买导师服务时，`user`服务需调用 `teacher`服务的 `get_tutor_service_price`接口，获取服务价格（确保价格一致性，避免前端传参篡改）；
   - 关注导师后，`user`服务需同步更新 `teacher`服务的“导师粉丝数”（通过调用 `teacher`服务的 `update_tutor_fan_count`接口）。
3. **数据一致性保障**：

   - 服务购买采用“数据库事务”：扣减钻石与创建订单在同一事务中，确保“钻石扣减成功则订单必生成，订单失败则钻石不扣减”；
   - 导师关注关系通过 `user_id+tutor_id`唯一约束，避免重复关注；粉丝数通过“更新计数器”而非实时统计，提升查询效率。

如果需要继续分析剩余页面，直接提供对应的React文件即可～
